name: Verify Testnet (Etherscan)

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with: { node-version: 22 }

      - name: Pin Hardhat & Toolbox versions
        run: |
          npm pkg set devDependencies.hardhat=2.26.3
          npm pkg set devDependencies["@nomicfoundation/hardhat-toolbox"]=6.1.0
          npm pkg set devDependencies.typescript=5.4.5
          npm pkg set devDependencies.ts-node=10.9.1
          npm pkg set devDependencies["@types/node"]=20.11.30
          npm pkg set dependencies["@openzeppelin/contracts"]=5.0.2
          npm i

      - name: Compile
        run: npx hardhat compile

      # addresses/testnet.json → env (jq, no heredoc)
      - name: Load addresses
        run: |
          test -f addresses/testnet.json
          echo "SALE=$(jq -r '.SALE' addresses/testnet.json)" >> $GITHUB_ENV
          echo "NBL=$(jq -r '.NBL' addresses/testnet.json)"   >> $GITHUB_ENV
          echo "USDT=$(jq -r '.USDT' addresses/testnet.json)" >> $GITHUB_ENV
          echo "REG=$(jq -r '.REG' addresses/testnet.json)"   >> $GITHUB_ENV
          echo "TREE=$(jq -r '.TREE' addresses/testnet.json)" >> $GITHUB_ENV
          echo "POOL=$(jq -r '.POOL' addresses/testnet.json)" >> $GITHUB_ENV
          # deploy logs में admin यही था:
          echo "ADMIN=0xE77F94010Fb3B01431E18015A1c9A56F74e79998" >> $GITHUB_ENV

      # key detection (step-env → flag)
      - name: Detect Etherscan key
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          if [ -n "$ETHERSCAN_API_KEY" ]; then echo HAS_KEY=1 >> $GITHUB_ENV; else echo HAS_KEY=0 >> $GITHUB_ENV; fi

      # Verify only when key present; simple args inline; no heredoc
      - name: Verify core contracts (if key present)
        if: env.HAS_KEY == '1'
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          echo "Using Etherscan key (masked)."
          npx hardhat verify --network bscTestnet "$NBL"  "$ADMIN" "10000000000000000000000000000" "1000000000000000000000000000" || true
          npx hardhat verify --network bscTestnet "$REG"  "$ADMIN" || true
          npx hardhat verify --network bscTestnet "$TREE" "$ADMIN" || true
          npx hardhat verify --network bscTestnet "$POOL" "$ADMIN" "$USDT" || true
          # SALE का verify बड़ा है; पहले चार के ग्रीन होते ही SALE पर जाएंगे

      - name: Skip note (no key)
        if: env.HAS_KEY != '1'
        run: echo "No ETHERSCAN_API_KEY in Secrets → skipping Etherscan verify."
