name: Verify Testnet (BscScan)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    # पहले जो error था: if में ${{ }} गायब था → अब ठीक
    if: ${{ secrets.ETHERSCAN_API_KEY != '' || secrets.BSCSCAN_KEY != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Pin Hardhat & Toolbox versions
        run: |
          npm pkg set devDependencies.hardhat=2.26.3
          npm pkg set devDependencies["@nomicfoundation/hardhat-toolbox"]=6.1.0
          npm pkg set devDependencies.typescript=5.4.5
          npm pkg set devDependencies.ts-node=10.9.1
          npm pkg set devDependencies["@types/node"]=20.11.30
          npm pkg set dependencies["@openzeppelin/contracts"]=5.0.2

      - name: Force CommonJS (package.json + tsconfig)
        run: |
          node -e "let fs=require('fs');let p=JSON.parse(fs.readFileSync('package.json','utf8'));p.type='commonjs';fs.writeFileSync('package.json',JSON.stringify(p,null,2));"
          sed -i 's/"module": *"NodeNext"/"module": "commonjs"/' tsconfig.json || true
          sed -i 's/"moduleResolution": *"NodeNext"/"moduleResolution": "node"/' tsconfig.json || true

      - name: Install deps
        run: npm i

      - name: Compile
        run: npx hardhat compile

      - name: Load addresses from addresses/testnet.json
        run: |
          test -f addresses/testnet.json || { echo "addresses/testnet.json missing"; exit 1; }
          echo "USDT=$(jq -r '.USDT' addresses/testnet.json)" >> $GITHUB_ENV
          echo "NBL=$(jq -r '.NBL' addresses/testnet.json)" >> $GITHUB_ENV
          echo "REG=$(jq -r '.REG' addresses/testnet.json)" >> $GITHUB_ENV
          echo "TREE=$(jq -r '.TREE' addresses/testnet.json)" >> $GITHUB_ENV
          echo "POOL=$(jq -r '.POOL' addresses/testnet.json)" >> $GITHUB_ENV
          echo "SALE=$(jq -r '.SALE' addresses/testnet.json)" >> $GITHUB_ENV
          echo "ADMIN=0xE77F94010Fb3B01431E18015A1c9A56F74e79998" >> $GITHUB_ENV
          echo "TREASURY=${{ vars.TREASURY || '0x05A5bc620D55708776c8B52f38A3F5bf0b9DC420' }}" >> $GITHUB_ENV
          echo "PERMIT2=${{ vars.PERMIT2 || '0x0000000000000000000000000000000000000000' }}" >> $GITHUB_ENV

      - name: Verify on BSC Testnet
        env:
          # Etherscan multi-chain key (Etherscan/BscScan दोनों के लिए)
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY || secrets.BSCSCAN_KEY }}
        run: |
          # NBLToken(admin, cap, bonusCap)
          npx hardhat verify --network bscTestnet "$NBL" \
            "$ADMIN" \
            "10000000000000000000000000000" \
            "1000000000000000000000000000"

          # PartnerRegistry(admin)
          npx hardhat verify --network bscTestnet "$REG" "$ADMIN"

          # PartnerTree(admin)
          npx hardhat verify --network bscTestnet "$TREE" "$ADMIN"

          # PoolVault(admin, usdt)
          npx hardhat verify --network bscTestnet "$POOL" "$ADMIN" "$USDT"

          # NBLSaleV5(admin, nbl, usdt, reg, tree, pool, treasury, usdtDecimals, mode, min, max, permit2)
          # mode=0(INSTANT), min=50e18, max=10000e18 (USDT decimals=18 on BSC testnet)
          npx hardhat verify --network bscTestnet "$SALE" \
            "$ADMIN" "$NBL" "$USDT" "$REG" "$TREE" "$POOL" \
            "$TREASURY" "18" "0" \
            "50000000000000000000" "10000000000000000000000" \
            "$PERMIT2"
